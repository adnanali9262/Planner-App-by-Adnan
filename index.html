<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Firebase Planner</title>
<style>
  body { font-family: sans-serif; margin:0; background:#f7f9fc; }
  header { background:#3aa675; color:white; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
  .container { max-width:1000px; margin:auto; padding:20px; display:flex; gap:20px; }
  .card { background:white; padding:16px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex:1; }
  input, textarea, button { width:100%; padding:8px; margin-top:5px; margin-bottom:10px; }
  button { background:#3aa675; color:white; border:none; border-radius:4px; cursor:pointer; }
  button:hover { background:#339165; }
  .note { border:1px solid #ccc; padding:10px; border-radius:6px; margin-bottom:8px; background:#fafafa; }
  .hidden { display:none; }
  .note-actions { display:flex; gap:5px; margin-top:5px; }
  .note-actions button { flex:1; padding:5px; font-size:14px; }
</style>
</head>
<body>

<header>
  <h1>Planner</h1>
  <div id="auth-actions" class="hidden">
    <span id="user-email"></span>
    <button id="logout-btn">Logout</button>
  </div>
</header>

<!-- Auth Section -->
<div id="auth-section">
  <div class="container">
    <div class="card">
      <h2>Login</h2>
      <input id="login-email" type="email" placeholder="Email" />
      <input id="login-password" type="password" placeholder="Password" />
      <button id="login-btn">Login</button>
    </div>
    <div class="card">
      <h2>Register</h2>
      <input id="register-email" type="email" placeholder="Email" />
      <input id="register-password" type="password" placeholder="Password" />
      <button id="register-btn">Register</button>
    </div>
  </div>
</div>

<!-- Planner Section -->
<div id="planner-section" class="hidden">
  <div class="container">
    <!-- Add/Edit Note -->
    <div class="card">
      <h2 id="form-title">Add Note</h2>
      <input type="hidden" id="note-id" />
      <textarea id="note-text" placeholder="Write note..."></textarea>
      <input id="note-date" type="datetime-local" />
      <button id="save-note-btn">Save Note</button>
      <button id="cancel-edit-btn" class="hidden">Cancel Edit</button>
    </div>
    <!-- Notes List -->
    <div class="card">
      <h2>Your Notes</h2>
      <div id="notes-list"></div>
    </div>
  </div>
</div>

<!-- Firebase Modular SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // ðŸ”¹ Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAdT__ih2Cpx63eelLR3fkZuOp_XCdNc3k",
    authDomain: "planner-project-87612.firebaseapp.com",
    projectId: "planner-project-87612",
    storageBucket: "planner-project-87612.firebasestorage.app",
    messagingSenderId: "625352854092",
    appId: "1:625352854092:web:ec816304828365d727c2e9"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Elements
  const authSection = document.getElementById('auth-section');
  const plannerSection = document.getElementById('planner-section');
  const authActions = document.getElementById('auth-actions');
  const userEmailSpan = document.getElementById('user-email');
  const notesList = document.getElementById('notes-list');

  const noteIdInput = document.getElementById('note-id');
  const noteTextInput = document.getElementById('note-text');
  const noteDateInput = document.getElementById('note-date');
  const saveNoteBtn = document.getElementById('save-note-btn');
  const cancelEditBtn = document.getElementById('cancel-edit-btn');
  const formTitle = document.getElementById('form-title');

  let unsubscribeNotes = null; // live listener unsubscribe

  // Register
  document.getElementById('register-btn').addEventListener('click', async () => {
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert(err.message);
    }
  });

  // Login
  document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert(err.message);
    }
  });

  // Logout
  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
  });

  // Save Note
  saveNoteBtn.addEventListener('click', async () => {
    const text = noteTextInput.value.trim();
    const date = noteDateInput.value;
    if (!text || !date) return alert("Fill both note and date");

    const user = auth.currentUser;
    if (!user) return;

    if (noteIdInput.value) {
      // Editing existing note
      const noteRef = doc(db, "notes", user.uid, "userNotes", noteIdInput.value);
      await updateDoc(noteRef, { text, followUp: date });
      resetForm();
    } else {
      // Adding new note
      await addDoc(collection(db, "notes", user.uid, "userNotes"), {
        text,
        followUp: date,
        createdAt: serverTimestamp()
      });
    }

    noteTextInput.value = '';
    noteDateInput.value = '';
  });

  cancelEditBtn.addEventListener('click', resetForm);

  function resetForm() {
    noteIdInput.value = '';
    noteTextInput.value = '';
    noteDateInput.value = '';
    formTitle.textContent = "Add Note";
    cancelEditBtn.classList.add('hidden');
  }

  // Edit Note
  function editNote(id, text, followUp) {
    noteIdInput.value = id;
    noteTextInput.value = text;
    noteDateInput.value = followUp;
    formTitle.textContent = "Edit Note";
    cancelEditBtn.classList.remove('hidden');
  }

  // Delete Note
  async function deleteNote(id) {
    const user = auth.currentUser;
    if (!user) return;
    if (confirm("Delete this note?")) {
      await deleteDoc(doc(db, "notes", user.uid, "userNotes", id));
    }
  }

  // Live Notes Listener
  function subscribeNotes(uid) {
    if (unsubscribeNotes) unsubscribeNotes();
    const q = query(collection(db, "notes", uid, "userNotes"), orderBy("followUp"));
    unsubscribeNotes = onSnapshot(q, snapshot => {
      notesList.innerHTML = '';
      snapshot.forEach(docSnap => {
        const note = docSnap.data();
        const div = document.createElement('div');
        div.className = 'note';
        div.innerHTML = `
          <b>${note.text}</b><br>
          <small>${note.followUp || ''}</small>
          <div class="note-actions">
            <button onclick="editNote('${docSnap.id}', \`${note.text}\`, '${note.followUp}')">Edit</button>
            <button onclick="deleteNote('${docSnap.id}')">Delete</button>
          </div>
        `;
        notesList.appendChild(div);
      });
    });
  }

  // Auth State Change
  onAuthStateChanged(auth, user => {
    if (user) {
      authSection.classList.add('hidden');
      plannerSection.classList.remove('hidden');
      authActions.classList.remove('hidden');
      userEmailSpan.textContent = user.email;
      subscribeNotes(user.uid);
    } else {
      authSection.classList.remove('hidden');
      plannerSection.classList.add('hidden');
      authActions.classList.add('hidden');
      notesList.innerHTML = '';
      if (unsubscribeNotes) unsubscribeNotes();
    }
  });

  // Make functions global for inline onclick
  window.editNote = editNote;
  window.deleteNote = deleteNote;

</script>
</body>
</html>
